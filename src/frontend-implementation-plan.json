{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Modal-first upgrade flow with in-modal payment confirmation and no redirects",
  "requirements": [
    {
      "id": "REQ-94",
      "summary": "Ensure all upgrade CTAs only open the in-app PricingComparisonModal and never initiate payment or navigate externally on first click.",
      "acceptanceCriteria": [
        "Clicking any upgrade CTA keeps the user on the current page and opens the in-app pricing modal (Dialog) instead of navigating away.",
        "No upgrade CTA directly calls the Razorpay initiation function on first click; it only opens the PricingComparisonModal.",
        "The browser URL is not redirected to any Razorpay/checkout URL as a result of the initial upgrade click."
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Audit and ensure the single app-level upgrade entry point (openPricingModal) remains modal-only (no payment initiation, no external navigation), and confirm all sections/components use it for upgrade CTAs. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/sections/PricingSection.tsx",
          "operation": "modify",
          "description": "Confirm Pricing section upgrade buttons only call openPricingModal (never useRazorpayUpgrade) and do not open any external checkout URL. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/features/subscription/PremiumLock.tsx",
          "operation": "modify",
          "description": "Ensure the Unlock Premium CTA continues to only open PricingComparisonModal via openPricingModal and never initiates payment directly. Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/features/subscription/UPGRADE_TESTING_CHECKLIST.md",
          "operation": "modify",
          "description": "Update checklist to reflect modal-first behavior for all upgrade CTAs and verify no upgrade click triggers Razorpay until explicit in-modal confirmation. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-95",
      "summary": "Add an in-modal confirmation step in PricingComparisonModal so plan upgrade buttons do not start Razorpay until the user explicitly confirms.",
      "acceptanceCriteria": [
        "Inside PricingComparisonModal, clicking “Upgrade to Pro/Creator” first shows a clear in-modal confirmation UI (still within the app) and does not open Razorpay immediately.",
        "Only after the user clicks a “Proceed to payment” (or equivalent) control inside the modal should the Razorpay flow be initiated.",
        "Closing/cancelling the confirmation step returns to the pricing modal content without navigating away from the app."
      ],
      "file_operations": [
        {
          "path": "frontend/src/features/subscription/PricingComparisonModal.tsx",
          "operation": "modify",
          "description": "Refactor PricingComparisonModal to use shadcn-ui Dialog content to include a secondary in-modal confirmation state per selected plan: initial click selects plan and reveals confirmation UI; only the confirmation control calls useRazorpayUpgrade.initiateUpgrade; add cancel/back to return to the comparison view without navigation. Verify the component's usage instructions before implementing."
        }
      ]
    },
    {
      "id": "REQ-96",
      "summary": "Prevent any full-page navigation during Razorpay initiation and show clear English toast errors when checkout cannot open, keeping the app usable.",
      "acceptanceCriteria": [
        "Initiating payment does not change window.location or navigate the SPA to a new page.",
        "If Razorpay cannot open (SDK missing/not loaded/config missing), the app shows an English toast error and remains usable.",
        "The existing payment-configuration missing message remains English and actionable."
      ],
      "file_operations": [
        {
          "path": "frontend/src/features/payments/razorpay.ts",
          "operation": "modify",
          "description": "Harden useRazorpayUpgrade so initiating payment never triggers full-page navigation: add explicit guards against missing SDK/config, surface a clear English toast when the SDK fails to load or checkout cannot be opened, and ensure all error messaging remains actionable and keeps the user in-app (no window.location changes). Verify the component's usage instructions before implementing."
        },
        {
          "path": "frontend/src/features/subscription/PricingComparisonModal.tsx",
          "operation": "modify",
          "description": "Ensure the confirmation step integrates with the updated useRazorpayUpgrade failure states: if initiation fails, keep the modal open and show the English toast error without navigating away. Verify the component's usage instructions before implementing."
        }
      ]
    }
  ]
}