{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Add Google Analytics (gtag.js) tracking and CSP allowances",
  "requirements": [
    {
      "id": "REQ-62",
      "summary": "Load the provided Google Analytics gtag.js snippet on every page using measurement ID G-ZPB7R21LJ4.",
      "acceptanceCriteria": [
        "The built appâ€™s delivered HTML includes the exact Google tag (gtag.js) snippet with measurement ID G-ZPB7R21LJ4.",
        "On a fresh load, the browser requests https://www.googletagmanager.com/gtag/js?id=G-ZPB7R21LJ4 successfully.",
        "After page load, window.dataLayer exists and window.gtag is defined (or equivalent gtag function behavior is present)."
      ],
      "file_operations": [
        {
          "path": "frontend/index.html",
          "operation": "modify",
          "description": "Insert the exact provided Google tag (gtag.js) snippet into the document <head> so it loads on every page view, using measurement ID G-ZPB7R21LJ4."
        }
      ]
    },
    {
      "id": "REQ-63",
      "summary": "Adjust deployed CSP to allow Google Analytics (gtag.js) resources while preserving existing Internet Identity and app functionality.",
      "acceptanceCriteria": [
        "With CSP enabled in production, the GA script loads without CSP violations in the browser console.",
        "Network requests needed by Google Analytics measurement (initiated by gtag.js) are not blocked by CSP.",
        "Existing authentication (Internet Identity) and app API calls remain functional after the CSP change."
      ],
      "file_operations": [
        {
          "path": "frontend/.ic-assets.json",
          "operation": "modify",
          "description": "Update the Content-Security-Policy header to allow loading gtag.js and sending analytics beacons by permitting required Google hosts (at minimum add https://www.googletagmanager.com to allowed script sources and add Google Analytics collection hosts such as https://www.google-analytics.com to connect-src), while keeping current allowances needed for Internet Identity (https://identity.ic0.app) and existing app connectivity unchanged. Ensure the CSP is applied to index.html responses as deployed (add/duplicate the CSP header under the index.html rule if the asset rules override headers)."
        }
      ]
    }
  ]
}